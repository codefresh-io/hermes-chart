version: '1.0'

steps:

  check_vars:
    title: check for expected variables
    image: alpine:3.7
    commands:
    - "if [ ! -n \"$HERM_REPO_PATH\" ]; then echo \"HERM_REPO_PATH is not defined\" && exit 1; fi"
    - "echo $HERM_REPO_PATH"
    
  package_chart:
    title: package hermes chart
    image: codefresh/plugin-helm:2.8.1
    commands:
    - helm init --client-only
    - helm package -u hermes

  update_chart_repo:
    title: update hermes chart in repository
    image: codefresh/plugin-helm:2.8.1
    commands:
    - "VERSION=$(grep \"version: \" hermes/Chart.yaml | awk '{print $2}')"
    - "PACKAGE=hermes-$VERSION.tgz"
    - "curl --user ${{BASIC_AUTH_USER}}:${{BASIC_AUTH_PASS}} --fail --data-binary \"@$PACKAGE\" $HELM_REPO_PATH"
